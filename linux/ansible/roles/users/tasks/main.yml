---
- name: Get human users
  become: true
  ansible.builtin.getent:
    database: passwd
  register: passwd

- name: Get groups
  become: true
  ansible.builtin.getent:
    database: group


# TODO: Only have it generate passwords for users that already have a password, right now it generates for every users
- name: Shuffle passwd user passwords
  become: true
  when: users_passwords_shuffle
  block:
    # Below part can probably be merged into a single task somehow.
    # Also a when statement, for when it's not needed.
    - name: Create gitignore
      become: true
      ansible.builtin.template:
        src: templates/gitignore.j2
        dest: /tmp/gitignore
        mode: '0644'
    - name: Fetch gitignore
      ansible.builtin.fetch:
        src: /tmp/gitignore
        dest: "{{ playbook_dir }}/passwords/.gitignore"
        flat: true
    - name: Delete gitignore file from server
      become: true
      ansible.builtin.file:
        path: /tmp/gitignore
        state: absent
    # Parse this to only do human users or something because this sucks.

    - name: Create random location for passwords csv
      ansible.builtin.set_fact:
        passwordlistfile: "{{ lookup('community.general.random_string', length=12, special=false) }}"
    - name: Create scoring engine CSV
      ansible.builtin.file:
        dest: "/tmp/{{ passwordlistfile }}"
        mode: '0644'
        state: touch

    - name: Loop through users, change passwords
      ansible.builtin.include_tasks:
        file: tasks/change_passwords.yml
      loop: "{{ passwd.ansible_facts.getent_passwd | dict2items | map(attribute='key') | list }}"
    - name: Fetch passwordlist
      ansible.builtin.fetch:
        src: "/tmp/{{ passwordlistfile }}"
        dest: "{{ playbook_dir }}/passwords/{{ ansible_facts['nodename'] }}/passwordlist.csv"
        flat: true
    - name: Delete passwordlist
      ansible.builtin.file:
        path: "/tmp/{{ passwordlistfile }}"
        state: absent




- name: Control who is admin
  when: users_admins is iterable # Checks if list is non-empty
  become: true
  block:
    - name: Delete everybody from admin groups
      ansible.builtin.include_tasks:
        file: tasks/remove_admins.yml
      loop: "{{ passwd.ansible_facts.getent_passwd | dict2items | map(attribute='key') | list }}"
    - name: Add users to admin groups
      ansible.builtin.include_tasks:
        file: tasks/add_admins.yml
      loop: "{{ users_admins }}"

- name: Control who is admin version 2
  when: false
  become: true
  block:
    - name: Get which users are part of admin groups
      ansible.builtin.set_fact:
        "{{ item }}": "{{ ansible_facts.getent_group.item[2].split(',') | list }}"
      loop: ["sudo","wheel","docker"]
    - name: List users in the groups
      ansible.builtin.debug:
        msg: "{{ sudo }}"